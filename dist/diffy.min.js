!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Diffy=t():e.Diffy=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var a=n[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="/",t(0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.create=void 0;var a=n(2),r=i(a),o=n(6),s=i(o),d=n(7),u=i(d);t.create=function(e){var t=e.resolution,n=e.sensitivity,i=e.debug,a=e.onFrame;if(!window)throw new Error("\n      Diffy.js is meant to be used in the browser. :^)\n      For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n    ");if(!1 in window)throw new Error("\n      Diffy.js requires Web Workers.\n      It looks like this environment does not support this feature. :(\n      For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n    ");return r.default.create({tickFn:s.default,captureFn:u.default,resolution:t,sensitivity:n,debug:i,onFrame:a})}},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=n(3),s=i(o),d=n(5),u=((0,d.createOnceLog)(),(0,d.createOnceLog)(),function(){function e(t){var n=t.tickFn,i=void 0===n?function(){}:n,r=t.captureFn,o=void 0===r?function(){}:r,d=t.captureConfig,u=void 0===d?{audio:!1,video:{width:130,height:100}}:d,l=t.debug,c=void 0!==l&&l,h=t.sourceDimensions,f=void 0===h?{w:130,h:100}:h,v=t.onFrame,m=void 0===v?function(e){}:v,p=t.sensitivity,g=void 0===p?.2:p,w=t.containerClassName,b=void 0===w?"diffy--debug-view":w,E=t.resolution,y=void 0===E?{x:10,y:5}:E;a(this,e),this.tickFn=i.bind(window),this.captureFn=o,this.onFrame=m,this.currentImageData=null,this.previousImageData=null,this.resolutionX=y.x,this.resolutionY=y.y,this.sensitivity=g,this.debug=c,this.containerClassName=b,this.debugViewCollapsed=!1,this.captureConfig=u,this.sourceWidth=f.w,this.sourceHeight=f.h,this.worker=new s.default,this.initialized=!1,window.addEventListener("load",this.init.bind(this))}return r(e,[{key:"toVideo",value:function(e,t){t.src=e}},{key:"toCanvas",value:function(e,t){t.getContext("2d").drawImage(e,0,0,t.width,t.height)}},{key:"mirror",value:function(e){var t=e.getContext("2d");return t.translate(e.width,0),t.scale(-1,1),e}},{key:"compare",value:function(e,t){var n=e.data,i=t.data,a=n.length,r=new ArrayBuffer(a);this.worker.postMessage({buffer:r,data1:n,data2:i,sensitivity:this.sensitivity,width:this.sourceWidth,height:this.sourceHeight})}},{key:"drawBlendImageFromBuffer",value:function(e){this.blendImageData.data.set(new Uint8ClampedArray(e)),this.blendCanvasCtx.putImageData(this.blendImageData,0,0),this.previousImageData=this.currentImageData}},{key:"blend",value:function(e){var t=e.getContext("2d"),n=e.width,i=e.height;this.currentImageData=t.getImageData(0,0,n,i),this.previousImageData=this.previousImageData||t.getImageData(0,0,n,i),this.compare(this.currentImageData,this.previousImageData)}},{key:"createMatrix",value:function(){var e=void 0,t=void 0,n=0,i=[],a=this.sourceWidth,r=this.sourceHeight,o=this.sourceWidth/this.resolutionX,s=this.sourceHeight/this.resolutionY,u=null,l=void 0,c=void 0,h=0;for(e=0;e<a;e+=o){var f=[];for(t=0;t<r;t+=s){for(u=this.blendCanvasCtx.getImageData(e,t,o,s).data,l=u.length,c=l/4;n<c;)h+=(u[4*n]+u[4*n+1]+u[4*n+2])/3,++n;h=(0,d.round)(h/c),f.push(h),h=0,n=0}i.push(f)}return i}},{key:"loop",value:function(){this.toCanvas(this.videoEl,this.rawCanvasEl),this.blend(this.rawCanvasEl),this.onFrame(this.createMatrix()),this.tickFn(this.loop.bind(this))}},{key:"init",value:function(){var e=this;this.worker.addEventListener("error",function(e){throw e}),this.worker.addEventListener("message",function(t){var n=t.data;e.drawBlendImageFromBuffer(n)}),this.initDom(this.containerClassName),this.blendCanvasCtx=this.blendCanvasEl.getContext("2d"),this.blendImageData=this.blendCanvasCtx.getImageData(0,0,this.sourceWidth,this.sourceHeight),this.captureFn(this.captureConfig).then(function(t){[e.rawCanvasEl,e.blendCanvasEl].forEach(e.mirror),e.toVideo(t,e.videoEl),e.loop()}),this.initialized=!0}},{key:"createElements",value:function(e){var t=this;this.containerEl=document.createElement("div"),this.containerEl.className=e,this.videoEl=document.createElement("video"),this.videoEl.className="video view",this.videoEl.setAttribute("autoplay",""),this.videoEl.width=this.sourceWidth,this.videoEl.height=this.sourceHeight,this.rawCanvasEl=document.createElement("canvas"),this.rawCanvasEl.className="canvas--raw view",this.rawCanvasEl.width=this.sourceWidth,this.rawCanvasEl.height=this.sourceHeight,this.blendCanvasEl=document.createElement("canvas"),this.blendCanvasEl.className="canvas--blend view",this.blendCanvasEl.width=this.sourceWidth,this.blendCanvasEl.height=this.sourceHeight,this.headerEl=document.createElement("header"),this.headerEl.className="header",this.titleEl=document.createElement("h1"),this.titleEl.className="title",this.titleEl.innerText="Diffy debug view",this.toggleEl=document.createElement("span"),this.toggleEl.className="toggle",this.toggleEl.innerText="-",this.headerEl.addEventListener("click",function(e){e.preventDefault(),[t.videoEl,t.rawCanvasEl,t.blendCanvasEl].forEach(function(e){t.debugViewCollapsed?(e.classList.remove("hidden"),t.toggleEl.innerText="-"):(e.classList.add("hidden"),t.toggleEl.innerText="+")}),t.debugViewCollapsed=!t.debugViewCollapsed}),this.headerEl.appendChild(this.toggleEl),this.headerEl.appendChild(this.titleEl),this.containerEl.appendChild(this.headerEl),this.containerEl.appendChild(this.videoEl),this.containerEl.appendChild(this.rawCanvasEl),this.containerEl.appendChild(this.blendCanvasEl),document.body.appendChild(this.containerEl),this.debug||this.containerEl.classList.add("hidden")}},{key:"injectCssStyles",value:function(){var e=document.createElement("style"),t=this.containerClassName,n="\n      ."+t+" {\n        position: fixed;\n        top: 0;\n        left: 0;\n        font-family: monospace;\n        background-color: #000;\n        border: 4px solid #000;\n        color: #fff;\n      }\n      ."+t+" .header {\n        width: 100%;\n        background-color: #000;\n        font-size: 16px;\n        cursor: pointer;\n      }\n      ."+t+" .title {\n        display: inline;\n        margin-left: 10px;\n        font-weight: 100;\n        font-size: 16px;\n      }\n      ."+t+" .toggle {\n        padding: 5px;\n      }\n\n      ."+t+" .view {\n        padding: 5px;\n      }\n\n      ."+t+" .view.hidden {\n        display: none;\n      }\n\n      ."+t+".hidden {\n        display: none;\n      }\n    ";e.innerHTML=n,document.body.appendChild(e)}},{key:"initDom",value:function(e){this.createElements(e),this.injectCssStyles()}}],[{key:"create",value:function(t){if(e.instanceExists)throw new Error("\n        Yikes! It seems like a Diffy.js instance already exists on this page. :|\n        For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n      ");return e.instanceExists=!0,new this(t)}}]),e}());u.instanceExists=!1,u.VERSION="1.0.1",t.default=u},function(e,t,n){e.exports=function(){return n(4)('!function(r){function e(n){if(t[n])return t[n].exports;var o=t[n]={exports:{},id:n,loaded:!1};return r[n].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var t={};return e.m=r,e.c=t,e.p="/",e(0)}([function(r,e,t){"use strict";var n=t(1),o=void 0,i=void 0,a=void 0,u=void 0,c=void 0,s=function(r){var e=r.data,t=e.buffer,s=e.data1,d=e.data2,f=e.width,v=e.height,l=e.sensitivity,p=0;c=1-l,o=new Uint32Array(t);for(var g=0;g<v;++g)for(var x=0;x<f;++x)p=g*f+x,i=(s[4*p]+s[4*p+1]+s[4*p+2])/3/c,a=(d[4*p]+d[4*p+1]+d[4*p+2])/3/c,u=(0,n.polarize)((0,n.abs)(i-a),21),o[p]=255<<24|u<<16|u<<8|u;postMessage(t)};onmessage=s},function(r,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.createOnceLog=function(){var r=0;return function(){if(r<1){var e;(e=console).log.apply(e,arguments)}r++}},e.$=function(r){return document.querySelector(r)},e.round=function(r){return r+.5>>0},e.abs=function(r){return(r^r>>31)-(r>>31)},e.polarize=function(r,e){return r>e?0:255}}]);\n//# sourceMappingURL=a6882b19b6c320d25dad.worker.js.map',n.p+"a6882b19b6c320d25dad.worker.js")}},function(e,t){var n=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var i;try{var a=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;i=new a,i.append(e),i=i.getBlob()}catch(t){i=new Blob([e])}return new Worker(n.createObjectURL(i))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){return new Worker(t)}}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.createOnceLog=function(){var e=0;return function(){if(e<1){var t;(t=console).log.apply(t,arguments)}e++}},t.$=function(e){return document.querySelector(e)},t.round=function(e){return e+.5>>0},t.abs=function(e){return(e^e>>31)-(e>>31)},t.polarize=function(e,t){return e>t?0:255}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};t.default=n},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function e(t,n,i){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return e?new Promise(function(n,i){e.call(navigator,t,n,i)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=n);var i=function(e){return navigator.mediaDevices.getUserMedia(e).then(function(e){return window.URL.createObjectURL(e)}).catch(function(e){var t=e.name,n=e.message;return console.error(t+" : "+n)})};t.default=i}])});
//# sourceMappingURL=diffy.min.js.map